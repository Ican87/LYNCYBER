<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LYN CHAT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto+Mono:wght@300;400;700&display=swap');
        @import url('https://fonts.cdnfonts.com/css/novante-sans');
        
        body {
            font-family: 'Novante Sans', sans-serif;
            background-color: #1a120b;
            color: #d4af37;
            overflow-x: hidden;
        }

        .logo-container {
            border: 1px solid #d4af37;
            box-shadow: 0 0 10px #8a5a00, 
                        inset 0 0 10px #8a5a00;
            animation: borderAnimation 20s linear infinite;
            background-image: radial-gradient(circle, transparent 20%, #1a120b 20%, #1a120b 80%, transparent 80%, transparent), radial-gradient(circle, transparent 20%, #1a120b 20%, #1a120b 80%, transparent 80%, transparent), linear-gradient(#d4af37 2px, transparent 2px), linear-gradient(90deg, #d4af37 2px, transparent 2px);
            background-size: 50px 50px, 50px 50px, 10px 10px, 10px 10px;
            background-position: 0 0, 25px 25px, 0 0, 0 0;
        }
        
        .cyberpunk-font {
            font-family: 'Orbitron', sans-serif;
        }
        
        .cyberpunk-box {
            border: 1px solid #d4af37;
            box-shadow: 0 0 10px #d4af37, 
                        inset 0 0 10px #d4af37;
            position: relative;
            overflow: hidden;
            background: linear-gradient(145deg, #1a120b, #2a1e0f);
            border-radius: 4px;
        }
        
        .cyberpunk-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff8c00, #ffa500, #ff8c00, #ffa500);
            background-size: 400%;
            z-index: -1;
            animation: borderAnimation 20s linear infinite;
            opacity: 0.7;
        }
        
        @keyframes borderAnimation {
            0% {
                background-position: 0 0;
            }
            50% {
                background-position: 400% 0;
            }
            100% {
                background-position: 0 0;
            }
        }
        
        .cyberpunk-input {
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 10px;
            font-family: 'Roboto Mono', monospace;
        }
        
        .cyberpunk-input:focus {
            outline: none;
            box-shadow: 0 0 10px #00ff41;
        }
        
        .cyberpunk-btn {
            background: linear-gradient(45deg, #5c3b00, #8a5a00);
            color: #ffd700;
            border: 1px solid #ffd700;
            font-family: 'Orbitron', sans-serif;
            letter-spacing: 1px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .cyberpunk-btn:hover {
            background: linear-gradient(45deg, #8a5a00, #ffd700);
            box-shadow: 0 0 15px #ffd700;
            transform: translateY(-2px);
        }

        .gear-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffd700"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.04-.32.07-.64.07-.97 0-.33-.03-.66-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.31-.61-.22l-2.49 1c-.52-.39-1.06-.73-1.69-.98l-.37-2.65c-.04-.24-.24-.42-.49-.42h-4c-.25 0-.46.18-.49.42l-.37 2.65c-.63.25-1.17.59-1.69.98l-2.49-1c-.22-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.04.34-.07.67-.07 1 0 .33.03.65.07.97l-2.11 1.66c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.31.61.22l2.49-1.01c.52.4 1.06.74 1.69.99l.37 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.37-2.65c.63-.26 1.17-.59 1.69-.99l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66z"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            transition: transform 0.3s;
            margin-right: 8px;
        }

        .cyberpunk-btn:hover .gear-icon {
            transform: rotate(30deg);
        }

        .cyberpunk-btn:active .gear-icon {
            transform: rotate(90deg);
        }

        .gear-spin {
            animation: gearSpin 0.5s linear infinite;
        }

        @keyframes gearSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .text-purple-500 {
            color: #8b5cf6;
        }
        
        .cyberpunk-btn:active {
            transform: translateY(0);
        }
        
        .cyberpunk-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        
        .cyberpunk-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .cyberpunk-scrollbar::-webkit-scrollbar-thumb {
            background: #00ff41;
            border-radius: 5px;
        }
        
        .scanline {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255, 165, 0, 0.2) 0%,
                rgba(255, 165, 0, 0) 10%
            );
            background-size: 100% 8px;
            animation: scanline 8s linear infinite;
            pointer-events: none;
            z-index: 10;
        }
        
        @keyframes scanline {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 0 100%;
            }
        }
        
        .glitch {
            position: relative;
        }
        
        .glitch::before, .glitch::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.8;
        }
        
        .glitch::before {
            color: #0ff;
            z-index: -1;
            animation: glitch-effect 3s infinite;
        }
        
        .glitch::after {
            color: #f0f;
            z-index: -2;
            animation: glitch-effect 2s infinite reverse;
        }
        
        @keyframes glitch-effect {
            0% {
                transform: translate(0);
            }
            20% {
                transform: translate(-3px, 3px);
            }
            40% {
                transform: translate(-3px, -3px);
            }
            60% {
                transform: translate(3px, 3px);
            }
            80% {
                transform: translate(3px, -3px);
            }
            100% {
                transform: translate(0);
            }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
        /* Stream Request Modal */
        .stream-request-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .stream-request-content {
            background: #111;
            border: 1px solid #00ff41;
            padding: 20px;
            max-width: 400px;
            width: 100%;
            border-radius: 5px;
            box-shadow: 0 0 15px #00ff41;
        }
        
        .stream-user-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .stream-user-item {
            padding: 8px 10px;
            margin-bottom: 5px;
            background: #222;
            border: 1px solid #333;
            cursor: pointer;
        }
        
        .stream-user-item:hover {
            border-color: #00ff41;
        }

        .terminal-cursor {
            display: inline-block;
            width: 10px;
            height: 20px;
            background-color: #00ff41;
            animation: blink 1s step-end infinite;
        }
        
        @keyframes blink {
            from, to {
                background-color: transparent;
            }
            50% {
                background-color: #00ff41;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="scanline"></div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="cyberpunk-box w-full max-w-md p-8 rounded-lg relative overflow-hidden">
        <div class="absolute inset-0 bg-black opacity-90"></div>
        <div class="relative z-10">
            <h1 class="cyberpunk-font text-3xl md:text-4xl text-center mb-6 glitch" data-text="LYNCHAT 2.0">LYNCHAT 2.0</h1>
            
            <div class="mb-6">
                <label for="nickname" class="block text-sm mb-2">ENTER YOUR NICKNAME</label>
                <input type="text" id="nickname" class="cyberpunk-input w-full p-3 rounded" placeholder="ENTER YOUR NICKNAME">
            </div>
            
            <div class="mb-6">
                <label class="block text-sm mb-2">FOLLOW OUR INSTAGRAM</label>
                <div class="flex items-center cyberpunk-box p-3">
                    <i class="fab fa-instagram text-xl mr-3 text-purple-400"></i>
                    <span class="flex-1">@exvisuites</span>
                    <button id="verifyBtn" class="cyberpunk-btn px-3 py-1 rounded text-xs">
                        <span class="gear-icon"></span> VERIFY
                    </button>
                </div>
                <div id="followStatus" class="text-xs mt-2 hidden">
                    <i class="fas fa-check-circle text-green-400 mr-1"></i>
                    <span>FOLLOW VERIFIED</span>
                </div>
            </div>
            
            <button id="joinBtn" disabled class="cyberpunk-btn w-full py-3 rounded-lg flex items-center justify-center opacity-50 cursor-not-allowed">
                <span>ACCESS DENIED</span>
                <i class="fas fa-lock ml-2"></i>
            </button>
            
            <div class="mt-6 text-xs text-center text-gray-500">
                <p>WARNING: UNAUTHORIZED ACCESS WILL BE TRACED</p>
                <p class="mt-1">ALL ACTIVITIES ARE LOGGED</p>
            </div>
        </div>
    </div>
    
    <!-- Chat Room -->
    <div id="chatRoom" class="hidden w-full max-w-4xl h-[70vh] cyberpunk-box rounded-lg relative overflow-hidden">
        <div class="absolute inset-0 bg-black opacity-90"></div>
        <div class="relative z-10 h-full flex flex-col">
            <!-- Header -->
            <div class="border-b border-green-500 p-3 md:p-4 flex justify-between items-center">
                <div>
                    <h2 class="cyberpunk-font text-lg md:text-xl">LYNCHAT</h2>
                    <div class="flex items-center text-[10px] md:text-xs">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 pulse"></div>
                        <span id="connectionStatus">CONNECTING...</span>
                    </div>
                </div>
                <div class="text-xs md:text-sm">
                    <span id="userCount">0</span> USERS
                </div>
                <div class="text-xs md:text-sm">
                    <span id="currentUser" class="text-green-400">GUEST</span>
                </div>
                <button id="startStreamBtn" class="cyberpunk-btn px-2 py-1 rounded text-[10px] md:px-3 md:text-sm mr-2 hidden">
                    <span class="gear-icon"></span> <span class="hidden md:inline">STREAM</span>
                </button>
                <button id="requestStreamBtn" class="cyberpunk-btn px-2 py-1 rounded text-[10px] md:px-3 md:text-sm mr-2 hidden" title="Request stream from another user">
                    <span class="gear-icon"></span> <span class="hidden md:inline">REQUEST</span>
                </button>
                <button id="clearChatBtn" class="cyberpunk-btn px-2 py-1 rounded text-[10px] md:px-3 md:text-sm mr-2 hidden">
                    <span class="gear-icon"></span> <span class="hidden md:inline">CLEAR</span>
                </button>
                <button id="kickBtn" class="cyberpunk-btn px-2 py-1 rounded text-[10px] md:px-3 md:text-sm mr-2 hidden bg-red-600">
                    <span class="gear-icon"></span> <span class="hidden md:inline">KICK</span>
                </button>
                <button id="closeChatBtn" class="cyberpunk-btn px-2 py-1 rounded text-[10px] md:px-3 md:text-sm">
                    <span class="gear-icon"></span> <span class="hidden md:inline">CLOSE</span>
                </button>
            </div>
            
            <!-- Stream Container -->
            <div id="streamContainer" class="hidden p-4 border-b border-green-500">
                <div class="cyberpunk-box p-2">
                    <video id="streamVideo" class="w-full" autoplay playsinline></video>
                    <div class="flex justify-between mt-2">
                        <div class="text-xs text-green-400">
                            <span id="streamStatus">LIVE STREAM</span>
                        </div>
                        <div class="flex space-x-2">
                            <button id="approveBtn" class="cyberpunk-btn bg-yellow-600 px-2 py-1 rounded text-xs hidden">
                                <i class="fas fa-user-lock mr-1"></i> APPROVE
                            </button>
                            <button id="switchCameraBtn" class="cyberpunk-btn px-2 py-1 rounded text-xs hidden">
                                <i class="fas fa-sync-alt mr-1"></i> SWITCH
                            </button>
                            <button id="stopStreamBtn" class="cyberpunk-btn px-2 py-1 rounded text-xs">
                                <i class="fas fa-stop mr-1"></i> STOP
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Messages -->
            <div id="messages" class="flex-1 overflow-y-auto p-4 cyberpunk-scrollbar space-y-4">
            </div>
            
            <!-- Input Area -->
            <div class="border-t border-green-500 p-4">
                <div class="flex space-x-2">
                    <input type="text" id="messageInput" class="cyberpunk-input flex-1 rounded" placeholder="TYPE YOUR MESSAGE..." disabled>
                    <button id="sendBtn" class="cyberpunk-btn px-4 rounded flex items-center justify-center" disabled>
                        <i class="fas fa-paper-plane mr-2"></i>
                        <span>SEND</span>
                    </button>
                </div>
                <div class="flex justify-between mt-2 text-[10px] md:text-xs text-gray-500">
                    <div>
                        <span id="typingIndicator"></span>
                    </div>
                    <div>
                        <span id="characterCount">0/200</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7zwrxJVZPxEfM9ulVOUJOSCnMjb1kyk0",
  authDomain: "lynchat-f6fbc.firebaseapp.com",
  databaseURL: "https://lynchat-f6fbc-default-rtdb.firebaseio.com",
  projectId: "lynchat-f6fbc",
  storageBucket: "lynchat-f6fbc.appspot.com",
  messagingSenderId: "465251710149",
  appId: "1:465251710149:web:e6243a6ca5de6754c1ecac",
  measurementId: "G-LGDFQ5JK6G"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const clearChatBtn = document.getElementById('clearChatBtn');
        const loginScreen = document.getElementById('loginScreen');
        const startStreamBtn = document.getElementById('startStreamBtn');
        const stopStreamBtn = document.getElementById('stopStreamBtn');
        const streamContainer = document.getElementById('streamContainer');
        const streamVideo = document.getElementById('streamVideo');
        const streamStatus = document.getElementById('streamStatus');
        let mediaStream = null;
        const chatRoom = document.getElementById('chatRoom');
        const nicknameInput = document.getElementById('nickname');
        const verifyBtn = document.getElementById('verifyBtn');
        const followStatus = document.getElementById('followStatus');
        const joinBtn = document.getElementById('joinBtn');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const currentUser = document.getElementById('currentUser');
        const userCount = document.getElementById('userCount');
        const connectionStatus = document.getElementById('connectionStatus');
        const typingIndicator = document.getElementById('typingIndicator');
        const characterCount = document.getElementById('characterCount');
        // State
        let username = '';
        let isFollowing = false;
        let socket;
        let typingTimeout;
        let peerConnection;
        let localStream;
        let remoteStream;
        let isInitiator = false;
        let isChannelReady = false;
        let isStarted = false;
        const servers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };
        
        // Instagram follow verification
        verifyBtn.addEventListener('click', () => {
            // Open Instagram in new tab
            window.open('https://www.instagram.com/exvisuites/', '_blank');
            
            // Show verification UI
            verifyBtn.innerHTML = '<span class="gear-icon gear-spin"></span> VERIFYING...';
            
            // Simulate verification delay
            setTimeout(() => {
                isFollowing = true;
                followStatus.classList.remove('hidden');
                verifyBtn.classList.add('hidden');
                
                // Enable join button if nickname is filled
                if (nicknameInput.value.trim()) {
                    joinBtn.disabled = false;
                    joinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    joinBtn.innerHTML = '<span>ACCESS GRANTED</span> <i class="fas fa-unlock ml-2"></i>';
                }
            }, 2000);
        });
        
        // Enable join button when nickname is entered and following
        nicknameInput.addEventListener('input', () => {
            if (nicknameInput.value.trim() && isFollowing) {
                joinBtn.disabled = false;
                joinBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                joinBtn.innerHTML = '<span>ACCESS GRANTED</span> <i class="fas fa-unlock ml-2"></i>';
            } else {
                joinBtn.disabled = true;
                joinBtn.classList.add('opacity-50', 'cursor-not-allowed');
                joinBtn.innerHTML = '<span>ACCESS DENIED</span> <i class="fas fa-lock ml-2"></i>';
            }
        });
        
        // Join chat room
        joinBtn.addEventListener('click', () => {
    username = nicknameInput.value.trim() || 'ANONYMOUS_' + Math.floor(Math.random() * 1000);
    currentUser.textContent = username;

    // Deteksi admin
    const isAdmin = username.toLowerCase() === 'ichsan87';

    if (isAdmin) {
        currentUser.classList.add('text-purple-500');
        currentUser.innerHTML = `${username} <span class="text-xs">(ADMIN)</span>`;
        document.getElementById('clearChatBtn').classList.remove('hidden');
        document.getElementById('kickBtn').classList.remove('hidden');
        document.getElementById('requestStreamBtn').classList.remove('hidden'); // hanya admin
    } else {
        document.getElementById('startStreamBtn').classList.remove('hidden'); // hanya user biasa
    }

    loginScreen.classList.add('hidden');
    chatRoom.classList.remove('hidden');

    // Koneksi Firebase
    connectToChat();

    // Ambil pesan dari database
    const messagesRef = database.ref('messages');
    messagesRef.orderByChild('timestamp').limitToLast(100).on('child_added', (snapshot) => {
        const message = snapshot.val();
        addMessage(message.sender, message.text, message.sender === username);
    });

    // Update user count
    const usersRef = database.ref('users/' + username);
    usersRef.set(true);
    usersRef.onDisconnect().remove();

    const userCountRef = database.ref('users');
    userCountRef.on('value', (snapshot) => {
        const count = snapshot.numChildren();
        userCount.textContent = count;
    });

    // ✅ HANYA untuk user biasa → listen stream request dari admin
    if (!isAdmin) {
        database.ref(`stream-requests/${username}`).on('value', (snapshot) => {
            if (snapshot.exists()) {
                const request = snapshot.val();
                const approveBtn = document.getElementById('approveBtn');

                console.log('[USER] Received stream request:', request);

                if (confirm(`Admin @${request.requester} wants to view your stream. Approve?`)) {
                    approveBtn.dataset.requester = request.requester;
                    approveBtn.classList.remove('hidden');
                }

                snapshot.ref.remove(); // bersihkan permintaan
            }
        });
    }
});

        
        // Connect to Firebase
        function connectToChat() {
            connectionStatus.textContent = 'CONNECTING...';
            
            // Check Firebase connection
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    connectionStatus.textContent = 'CONNECTED';
                    connectionStatus.classList.remove('text-yellow-500');
                    connectionStatus.classList.add('text-green-500');
                    
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                    
                } else {
                    connectionStatus.textContent = 'DISCONNECTED';
                    connectionStatus.classList.remove('text-green-500');
                    connectionStatus.classList.add('text-red-500');
                }
            });
        }
        
        // Send message
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Typing indicator
        messageInput.addEventListener('input', () => {
            characterCount.textContent = `${messageInput.value.length}/200`;
            
            // Show typing indicator briefly
            typingIndicator.textContent = 'YOU ARE TYPING...';
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                typingIndicator.textContent = '';
            }, 2000);
        });
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && message.length <= 200) {
                // Save message to Firebase
                const messagesRef = database.ref('messages');
                const newMessageRef = messagesRef.push();
                newMessageRef.set({
                    sender: username,
                    text: message,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                messageInput.value = '';
                characterCount.textContent = '0/200';
            }
        }
        
        // Add message to chat
        function addMessage(sender, text, isCurrentUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            const isAdmin = sender.toLowerCase() === 'ichsan87';
            bubble.className = `max-w-xs md:max-w-md rounded-lg px-4 py-2 ${isCurrentUser ? 'bg-green-900 bg-opacity-50' : 'bg-gray-900 bg-opacity-50'} ${isAdmin ? 'border border-purple-500' : ''}`;
            
            const senderSpan = document.createElement('span');
            senderSpan.className = `text-lg font-bold ${isAdmin ? 'text-purple-500' : 'text-white'}`;
            senderSpan.textContent = `@${sender}`;
            
            const textDiv = document.createElement('div');
            textDiv.className = 'mt-1 text-lg font-semibold';
            textDiv.textContent = text;
            
            bubble.appendChild(senderSpan);
            bubble.appendChild(textDiv);
            messageDiv.appendChild(bubble);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Add system message
        function addSystemMessage(text) {
            const systemDiv = document.createElement('div');
            systemDiv.className = 'text-center text-base text-gray-500 my-2';
            systemDiv.textContent = text;
            messagesContainer.appendChild(systemDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Clear chat history
        // Kick user functionality
        document.getElementById('kickBtn').addEventListener('click', () => {
            const kickUser = prompt('Enter username to kick:');
            if (kickUser) {
                if (confirm(`Are you sure you want to kick @${kickUser}?`)) {
                    // Remove user from Firebase
                    database.ref('users/' + kickUser).remove()
                        .then(() => {
                            addSystemMessage(`@${kickUser} has been kicked from the chat`);
                            // Also clear their messages if desired
                            // database.ref('messages').orderByChild('sender').equalTo(kickUser).remove();
                        })
                        .catch((error) => {
                            addSystemMessage(`ERROR kicking @${kickUser}: ${error.message}`);
                        });
                }
            }
        });

        clearChatBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all chat history?')) {
                database.ref('messages').remove()
                    .then(() => {
                        messagesContainer.innerHTML = '';
                    })
                    .catch((error) => {
                        addSystemMessage(`ERROR: ${error.message}`);
                    });
            }
        });

        // Enhanced WebRTC streaming with P2P broadcasting
        startStreamBtn.addEventListener('click', async () => {
            try {
                // Get media with better constraints
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                streamVideo.srcObject = localStream;
                streamContainer.classList.remove('hidden');
                startStreamBtn.classList.add('hidden');
                document.getElementById('switchCameraBtn').classList.remove('hidden');
                document.getElementById('approveBtn').classList.add('hidden');
                addSystemMessage(`@${username} STARTED A P2P BROADCAST`);

                database.ref(`stream-requests/${username}`).once('value').then(snapshot => {
            if (snapshot.exists()) {
                const request = snapshot.val();
                const approveBtn = document.getElementById('approveBtn');
                approveBtn.dataset.requester = request.requester;
                approveBtn.classList.remove('hidden');
                addSystemMessage(`You have a pending stream request from @${request.requester}`);
                snapshot.ref.remove();
            }
        });
                        // Create signaling channel for broadcast
                const broadcastRef = database.ref('broadcasts/' + username);
                broadcastRef.set({
                    status: 'live',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                
                // Setup peer connection for broadcasting
                createPeerConnection();
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Create offer for viewers
                const offer = await peerConnection.createOffer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                await peerConnection.setLocalDescription(offer);
                
                // Save offer to Firebase
                broadcastRef.child('offer').set({
                    sdp: offer.sdp,
                    type: offer.type
                });
                
                // Listen for ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        broadcastRef.child('candidates').push({
                            candidate: event.candidate.candidate,
                            sdpMid: event.candidate.sdpMid,
                            sdpMLineIndex: event.candidate.sdpMLineIndex
                        });
                    }
                };
                
                // Clean up on disconnect
                peerConnection.onconnectionstatechange = () => {
                    if (peerConnection.connectionState === 'disconnected') {
                        broadcastRef.remove();
                        addSystemMessage(`@${username}'s broadcast ended`);
                    }
                };
                
            } catch (err) {
                addSystemMessage(`BROADCAST ERROR: ${err.message}`);
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
            }
        });

        stopStreamBtn.addEventListener('click', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                streamVideo.srcObject = null;
                streamContainer.classList.add('hidden');
                document.getElementById('approveBtn').classList.add('hidden');
                document.getElementById('switchCameraBtn').classList.add('hidden');
                startStreamBtn.classList.remove('hidden');
                addSystemMessage(`@${username} ENDED THE STREAM`);
                
                // Remove any pending approval requests
                database.ref(`stream-requests/${username}`).remove();
                
                if (peerConnection) {
                    peerConnection.close();
                    peerConnection = null;
                }
                isStarted = false;
                isInitiator = false;
                
                // Remove any pending approval
                const approveBtn = document.getElementById('approveBtn');
                if (approveBtn.dataset.requester) {
                    delete approveBtn.dataset.requester;
                }
            }
        });

        // Switch camera functionality
        document.getElementById('switchCameraBtn').addEventListener('click', async () => {
            try {
                if (!localStream) return;
                
                // Get current video track
                const videoTrack = localStream.getVideoTracks()[0];
                if (!videoTrack) return;
                
                // Get available devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length < 2) {
                    addSystemMessage('Only one camera available');
                    return;
                }
                
                // Find current device and switch to next
                const currentDeviceId = videoTrack.getSettings().deviceId;
                let nextDeviceIndex = 0;
                
                for (let i = 0; i < videoDevices.length; i++) {
                    if (videoDevices[i].deviceId === currentDeviceId) {
                        nextDeviceIndex = (i + 1) % videoDevices.length;
                        break;
                    }
                }
                
                // Stop current track
                videoTrack.stop();
                
                // Get new stream with switched camera
                const newStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        deviceId: { exact: videoDevices[nextDeviceIndex].deviceId },
                        facingMode: videoDevices[nextDeviceIndex].label.includes('front') ? 'user' : 'environment'
                    },
                    audio: true
                });
                
                // Replace the video track
                const newVideoTrack = newStream.getVideoTracks()[0];
                localStream.addTrack(newVideoTrack);
                localStream.removeTrack(videoTrack);
                streamVideo.srcObject = localStream;
                
                // Close the unused stream
                newStream.getTracks().filter(t => t.kind !== 'video').forEach(t => t.stop());
                
                addSystemMessage(`@${username} switched camera`);
            } catch (err) {
                addSystemMessage(`Camera switch error: ${err.message}`);
            }
        });

        function createPeerConnection() {
            try {
                peerConnection = new RTCPeerConnection(servers);
                peerConnection.onicecandidate = handleIceCandidate;
                peerConnection.ontrack = handleRemoteStreamAdded;
                isChannelReady = true;
            } catch (e) {
                addSystemMessage(`Failed to create PeerConnection: ${e.toString()}`);
            }
        }

        function handleIceCandidate(event) {
            if (event.candidate) {
                database.ref('stream-signals/' + username + '/candidate').set({
                    type: 'candidate',
                    label: event.candidate.sdpMLineIndex,
                    id: event.candidate.sdpMid,
                    candidate: event.candidate.candidate
                });
            }
        }

        function handleRemoteStreamAdded(event) {
            remoteStream = event.streams[0];
            streamVideo.srcObject = remoteStream;
        }

        function handleOffer(sender, offer) {
    if (!offer || !offer.sdp || !offer.type) {
        console.error('Invalid RTCSessionDescriptionInit:', offer);
        return;
    }

    if (!isInitiator && !isStarted) {
        createPeerConnection();
        isStarted = true;

        peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
            .then(() => {
                return peerConnection.createAnswer();
            })
            .then(answer => {
                return peerConnection.setLocalDescription(answer);
            })
            .then(() => {
                database.ref('stream-signals/' + sender + '/answer').set({
                    type: 'answer',
                    sdp: peerConnection.localDescription.sdp
                });
            })
            .catch(e => {
                console.error('Error handling offer:', e);
                addSystemMessage(`Error handling offer: ${e}`);
            });
    }
}

        function handleAnswer(answer) {
            peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
                .catch(e => {
                    addSystemMessage(`Error setting remote description: ${e}`);
                });
        }

        function handleCandidate(candidate) {
            const iceCandidate = new RTCIceCandidate({
                sdpMLineIndex: candidate.label,
                candidate: candidate.candidate
            });
            peerConnection.addIceCandidate(iceCandidate)
                .catch(e => {
                    addSystemMessage(`Error adding ICE candidate: ${e}`);
                });
        }

        // Listen for WebRTC signals
        database.ref('stream-signals/' + username).on('child_added', (snapshot) => {
            const signal = snapshot.val();
            if (signal.type === 'offer') {
                handleOffer(snapshot.key, signal);
            } else if (signal.type === 'answer' && isInitiator) {
                handleAnswer(signal);
            } else if (signal.type === 'candidate') {
                handleCandidate(signal);
            }
        });

        // Listen for streamer offers
       database.ref('streamerOffers/' + username).on('value', (snapshot) => {
    if (snapshot.exists()) {
        const data = snapshot.val();
        const offer = data.offer || data;  // <-- cek apakah bentuknya {sdp, type}
        const sender = data.sender || snapshot.key;

        if (!offer || !offer.sdp || !offer.type) {
            console.error('Invalid offer received:', offer);
            return;
        }

        handleOffer(sender, offer);
        snapshot.ref.remove();
    }
});

        // Listen for streamer requests
        database.ref('streamerRequest/' + username).on('value', (snapshot) => {
            if (snapshot.exists()) {
                const request = snapshot.val();
                if (confirm(`@${request.requester} wants to view your stream. Approve?`)) {
                    database.ref('streamerAnswers/' + request.requester).set({
                        broadcaster: username,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    });
                }
                snapshot.ref.remove();
            }
        });

        // Listen for streamer answers
        database.ref('streamerAnswers/' + username).on('value', (snapshot) => {
            if (snapshot.exists()) {
                const answer = snapshot.val();
                connectToBroadcast(answer.broadcaster);
                snapshot.ref.remove();
            }
        });

        // Listen for stream requests (for regular users)
        database.ref(`stream-requests/${username}`).on('value', (snapshot) => {
            if (snapshot.exists() && username.toLowerCase() !== 'ichsan87') {
                const request = snapshot.val();
                const approveBtn = document.getElementById('approveBtn');
                
                // Only show approval option if currently streaming
                if (streamContainer.classList.contains('hidden') === false) {
                    if (confirm(`Admin @${request.requester} wants to view your stream. Approve?`)) {
                        // Store requester info
                        approveBtn.dataset.requester = request.requester;
                        approveBtn.classList.remove('hidden');
                    }
                } else {
                    addSystemMessage(`Admin @${request.requester} requested stream but you're not broadcasting`);
                }
                
                // Remove the request
                snapshot.ref.remove();
            }
        });

        // Handle approval button click
        document.getElementById('approveBtn').addEventListener('click', function() {
            const requester = this.dataset.requester;
            if (requester) {
                // Notify requester that stream is approved
                database.ref(`stream-approvals/${requester}`).set({
                    broadcaster: username,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                this.classList.add('hidden');
                addSystemMessage(`Stream access granted to @${requester}`);
            }
        });

        // Listen for stream approvals (for admin)
        database.ref(`stream-approvals/${username}`).on('value', (snapshot) => {
            if (snapshot.exists() && username.toLowerCase() === 'ichsan87') {
                const approval = snapshot.val();
                connectToBroadcast(approval.broadcaster);
                snapshot.ref.remove();
            }
        });

        // Enhanced viewer connection for P2P streaming
        function connectToBroadcast(broadcaster) {
            if (peerConnection) return;
            
            createPeerConnection();
            streamContainer.classList.remove('hidden');
            streamStatus.textContent = `CONNECTING TO @${broadcaster}'s BROADCAST`;
            
            const broadcastRef = database.ref('broadcasts/' + broadcaster);
            
            // Listen for offer
            broadcastRef.child('offer').once('value').then(snapshot => {
                if (!snapshot.exists()) throw new Error('No broadcast offer found');
                
                const offer = snapshot.val();
                return peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            }).then(() => {
                return peerConnection.createAnswer();
            }).then(answer => {
                return peerConnection.setLocalDescription(answer);
            }).then(() => {
                // Send answer back to broadcaster
                broadcastRef.child('answer').set(peerConnection.localDescription.toJSON());
            }).catch(e => {
                addSystemMessage(`CONNECTION ERROR: ${e.message}`);
                if (peerConnection) peerConnection.close();
            });
            
            // Listen for ICE candidates
            broadcastRef.child('candidates').on('child_added', snapshot => {
                const candidate = new RTCIceCandidate(snapshot.val());
                peerConnection.addIceCandidate(candidate).catch(e => {
                    console.error('Error adding ICE candidate:', e);
                });
            });
            
            // Handle remote stream
            peerConnection.ontrack = (event) => {
                if (event.streams && event.streams[0]) {
                    streamVideo.srcObject = event.streams[0];
                    streamStatus.textContent = `WATCHING @${broadcaster}'s BROADCAST`;
                }
            };
            
            // Handle connection state
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    addSystemMessage(`Successfully connected to @${broadcaster}'s broadcast`);
                } else if (peerConnection.connectionState === 'disconnected') {
                    addSystemMessage(`Disconnected from @${broadcaster}'s broadcast`);
                    streamContainer.classList.add('hidden');
                    if (peerConnection) peerConnection.close();
                }
            };
        }

        // Listen for kick signals
        database.ref('kick-signals/' + username).on('value', (snapshot) => {
            if (snapshot.exists()) {
                const kickData = snapshot.val();
                addSystemMessage(`You have been kicked by admin @${kickData.admin}`);
                
                // Clean up and logout
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (peerConnection) {
                    peerConnection.close();
                }
                
                database.ref('users/' + username).remove();
                database.ref('messages').off();
                database.ref('users').off();
                database.ref('stream-signals/' + username).off();
                database.ref('kick-signals/' + username).remove();
                
                chatRoom.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                messagesContainer.innerHTML = '';
            }
        });

        // Close chat and return to login
        document.getElementById('closeChatBtn').addEventListener('click', () => {
            // Stop any active stream when closing chat
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            // If admin was watching someone's stream
            if (streamContainer.classList.contains('hidden') === false && 
                username.toLowerCase() === 'ichsan87') {
                streamContainer.classList.add('hidden');
                startStreamBtn.classList.remove('hidden');
                streamStatus.textContent = 'LIVE STREAM';
                document.getElementById('stopStreamBtn').textContent = 'STOP';
            }
            
            // Remove Firebase listeners
            database.ref('messages').off();
            database.ref('users/' + username).remove();
            database.ref('users').off();
            database.ref('stream-signals/' + username).off();
            
            // Clean up WebRTC
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            chatRoom.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            
            // Reset chat state and verification
            messagesContainer.innerHTML = '';
            messageInput.value = '';
            characterCount.textContent = '0/200';
            isFollowing = false;
            followStatus.classList.add('hidden');
            verifyBtn.classList.remove('hidden');
            verifyBtn.innerHTML = '<span class="gear-icon"></span> VERIFY';
            joinBtn.disabled = true;
            joinBtn.classList.add('opacity-50', 'cursor-not-allowed');
            joinBtn.innerHTML = '<span>ACCESS DENIED</span> <i class="fas fa-lock ml-2"></i>';
        });

        // Terminal-like blinking cursor effect
        const cursor = document.createElement('span');
        cursor.className = 'terminal-cursor';
        document.body.appendChild(cursor);
        
        // Stream request functionality
        const requestStreamBtn = document.getElementById('requestStreamBtn');
        let currentStreamRequest = null;

        requestStreamBtn.addEventListener('click', () => {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'stream-request-modal';
            modal.innerHTML = `
                <div class="stream-request-content cyberpunk-font">
                    <h3 class="text-lg mb-4">REQUEST STREAM FROM USER</h3>
                    <div class="stream-user-list cyberpunk-scrollbar" id="streamUserList">
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-spinner fa-spin"></i> Loading users...
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="cancelRequestBtn" class="cyberpunk-btn px-4 py-1 text-sm">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Load available users
            database.ref('users').once('value').then(snapshot => {
                const userList = document.getElementById('streamUserList');
                userList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    userList.innerHTML = '<div class="text-center py-4 text-gray-500">No active users</div>';
                    return;
                }
                
                snapshot.forEach(user => {
                    if (user.key !== username && user.key.toLowerCase() !== 'ichsan87') {
                        const userItem = document.createElement('div');
                        userItem.className = 'stream-user-item';
                        userItem.textContent = '@' + user.key;
                        userItem.addEventListener('click', () => {
                            // Send stream request to user
                            database.ref(`stream-requests/${user.key}`).set({
                                requester: username,
                                timestamp: firebase.database.ServerValue.TIMESTAMP
                            });
                            modal.remove();
                            addSystemMessage(`Stream request sent to @${user.key}. Waiting for approval...`);
                        });
                        userList.appendChild(userItem);
                    }
                });
                
                if (userList.children.length === 0) {
                    userList.innerHTML = '<div class="text-center py-4 text-gray-500">No streamable users</div>';
                }
            });
            
            // Cancel button
            modal.querySelector('#cancelRequestBtn').addEventListener('click', () => {
                modal.remove();
            });
        });
        

        // Random glitch effect occasionally
        setInterval(() => {
            if (Math.random() > 0.9) {
                document.body.classList.add('glitch-effect');
                setTimeout(() => {
                    document.body.classList.remove('glitch-effect');
                }, 200);
            }
        }, 10000);
    </script>
<p style="border-radius: 8px; text-align: center; font-size: 12px; color: #fff; margin-top: 16px;position: fixed; left: 8px; bottom: 8px; z-index: 10; background: rgba(0, 0, 0, 0.8); padding: 4px 8px;">Made with <img src="https://enzostvs-deepsite.hf.space/logo.svg" alt="DeepSite Logo" style="width: 16px; height: 16px; vertical-align: middle;display:inline-block;margin-right:3px;filter:brightness(0) invert(1);"><a href="https://enzostvs-deepsite.hf.space" style="color: #fff;text-decoration: underline;" target="_blank" >DeepSite</a> - 🧬 <a href="https://enzostvs-deepsite.hf.space?remix=ican69/lynchat" style="color: #fff;text-decoration: underline;" target="_blank" >Remix</a></p></body>
</html>
